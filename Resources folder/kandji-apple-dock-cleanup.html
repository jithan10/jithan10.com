<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kandji Apple Dock Cleanup Script</title>
  <link rel="stylesheet" href="../style.css">
  <style>
    body { font-family: 'Inter', sans-serif; background: #f8f9fa; color: #222; margin: 40px; }
    h1 { font-size: 1.8em; color: #000; margin-bottom: 0.3em; }
    p { max-width: 800px; line-height: 1.6; }
    pre { background: #1e1e1e; color: #dcdcdc; padding: 15px; border-radius: 10px; overflow-x: auto; }
    .copy-btn { background: #007aff; color: #fff; border: none; border-radius: 8px; padding: 6px 12px; cursor: pointer; float: right; }
    .copy-btn:hover { background: #005bb5; }
  </style>
</head>
<body>
  <a href="../resources.html" style="text-decoration:none; color:#007aff;">← Back to Resources</a>
  <h1>Kandji Apple Dock Cleanup Script</h1>

  <p>
    This script safely clears all preloaded macOS Dock items for existing and future users without needing <code>dockutil</code>.
    It’s compatible with macOS Monterey through Sequoia and can be re-run safely. Ideal for Kandji deployment to provide a clean, minimal Dock setup for new users.
  </p>

  <button class="copy-btn" onclick="copyCode(this)">Copy</button>
  <pre><code>#!/bin/zsh
# Simple: empty the Dock for all users + default template (no dockutil required)
# macOS 12+ (Monterey) through Sequoia compatible. Safe to re-run.

set -euo pipefail

is_real_user() {
  local u="$1"
  local uid
  uid="$(/usr/bin/id -u "$u" 2>/dev/null || echo 0)"
  [[ "$uid" -ge 500 && "$u" != "root" ]]
}

user_home() {
  /usr/bin/dscl . -read "/Users/$1" NFSHomeDirectory 2>/dev/null | awk '{print $2}'
}

empty_user_dock() {
  local user="$1" home="$2"
  [[ -d "$home" ]] || return
  local plist="$home/Library/Preferences/com.apple.dock.plist"

  echo "Clearing Dock for $user ($home)…"
  /bin/mkdir -p "$home/Library/Preferences"

  /usr/bin/defaults write "$plist" persistent-apps -array
  /usr/bin/defaults write "$plist" persistent-others -array
  /usr/bin/defaults write "$plist" show-recents -bool false
  /usr/bin/defaults write "$plist" autohide -bool false

  /usr/sbin/chown "$user":"$(/usr/bin/id -gn "$user")" "$plist" 2>/dev/null || true
  su -l "$user" -c "/usr/bin/killall Dock" 2>/dev/null || true
}

empty_default_template() {
  echo "Clearing Dock in default user templates…"
  for tmpl in "/System/Library/User Template/"*; do
    [[ -d "$tmpl" ]] || continue
    local plist="$tmpl/Library/Preferences/com.apple.dock.plist"
    /bin/mkdir -p "$tmpl/Library/Preferences"

    /usr/bin/defaults write "$plist" persistent-apps -array
    /usr/bin/defaults write "$plist" persistent-others -array
    /usr/bin/defaults write "$plist" show-recents -bool false

    /usr/sbin/chown -R root:wheel "$tmpl"
  done
}

main() {
  /usr/bin/dscl . -list /Users | while read -r u; do
    is_real_user "$u" || continue
    h="$(user_home "$u")"
    [[ -n "$h" ]] && empty_user_dock "$u" "$h"
  done
  empty_default_template
  echo "Done."
}

main</code></pre>

  <p><strong>Usage:</strong> Save as <code>kandji-apple-dock-cleanup.sh</code> and deploy in Kandji as a “Run as root” script item.</p>

  <script>
  function copyCode(btn) {
    const code = btn.nextElementSibling.innerText;
    navigator.clipboard.writeText(code);
    btn.textContent = 'Copied!';
    setTimeout(() => (btn.textContent = 'Copy'), 2000);
  }
  </script>
</body>
</html>
